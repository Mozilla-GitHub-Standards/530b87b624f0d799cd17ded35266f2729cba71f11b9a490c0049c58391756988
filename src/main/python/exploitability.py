from optparse import OptionParser
import dateoption
from datetime import date, timedelta
import psycopg2
import os, sys
import csv

connectionstring = open(os.path.expanduser('~/socorro.connection'), 'r').read().strip()

conn = psycopg2.connect(connectionstring)
cur = conn.cursor()

cur.execute('''
WITH ExploitabilityBySignature AS (
  SELECT
    signature_id,
    SUM(CASE WHEN r.exploitability IS NULL THEN 1 ELSE 0 END) AS null_count,
    SUM(CASE WHEN r.exploitability = 'none' THEN 1 ELSE 0 END) AS none_count,
    SUM(CASE WHEN r.exploitability = 'low' THEN 1 ELSE 0 END) AS low_count,
    SUM(CASE WHEN r.exploitability = 'medium' THEN 1 ELSE 0 END) AS medium_count,
    SUM(CASE WHEN r.exploitability = 'high' THEN 1 ELSE 0 END) AS high_count
  FROM
    reports_clean r
    JOIN product_versions pv ON pv.product_version_id = r.product_version_id
  WHERE
    r.date_processed > '2014-01-04' AND
    pv.product_name = 'Firefox'
  GROUP BY signature_id
)
SELECT
  signature,
  null_count,
  none_count,
  low_count,
  medium_count,
  high_count,
  null_count + none_count + low_count + medium_count + high_count AS total,
  medium_count + high_count AS med_or_high,
  (medium_count + high_count) / (null_count + none_count + low_count + medium_count + high_count)::double precision AS ratio
FROM
  ExploitabilityBySignature AS ebs,
  signatures AS s
WHERE
  s.signature_id = ebs.signature_id
  AND null_count + none_count + low_count + medium_count + high_count > 4
ORDER BY
  med_or_high DESC
''')

csvw = csv.writer(sys.stdout)
csvw.writerow(('signature',
               'null_count',
               'none_count',
               'low_count',
               'medium_count',
               'high_count',
               'total',
               'med_or_high',
               'ratio'))
for r in cur:
    csvw.writerow(r)
